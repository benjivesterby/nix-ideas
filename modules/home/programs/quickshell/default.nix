{
  pkgs,
  config,
  lib,
  inputs,
  ...
}:
let
  palette = config.my.colors.palette.asHexWithHashtag;
  wallpaper = config.stylix.image;
in
{
  imports = [ inputs.niri-caelestia-shell.homeManagerModules.default ];

  config = lib.mkIf (config.my.roles.graphical.enable && !pkgs.stdenv.isDarwin) {
    programs.quickshell = {
      enable = true;
      activeConfig = null;
      systemd.enable = true;

      # Necessary for tray icons detection
      package = pkgs.symlinkJoin {
        name = "quickshell";
        paths = [ pkgs.quickshell ];
        nativeBuildInputs = [ pkgs.makeWrapper ];
        postBuild = ''
          wrapProgram $out/bin/quickshell --set QT_QPA_PLATFORMTHEME gtk3
        '';
      };
    };

    home.file."Pictures/Wallpapers/main.png".source = config.stylix.image;

    xdg.configFile."quickshell".source =
      config.lib.file.mkOutOfStoreSymlink "${config.my.configDir}/modules/home/programs/quickshell/config";
  };
}
